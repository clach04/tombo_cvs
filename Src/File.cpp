#include <windows.h>
#include "File.h"

//////////////////////////////////////////////////////////////////////
// dtor
//////////////////////////////////////////////////////////////////////

File::~File()
{
	Close();
}

//////////////////////////////////////////////////////////////////////
// ファイルオープン
//////////////////////////////////////////////////////////////////////

BOOL File::Open(LPCTSTR pFileName, DWORD nMode, DWORD nShareMode, DWORD nOpenMode)
{
	hFile = CreateFile(pFileName, nMode, nShareMode, NULL, 
						nOpenMode, FILE_ATTRIBUTE_NORMAL, NULL);
	if (hFile == INVALID_HANDLE_VALUE) return FALSE;

	if ((nSize = SetFilePointer(hFile, 0, NULL, FILE_END)) == 0xFFFFFFFF) {
		Close();
		return FALSE;
	}
	if (SetFilePointer(hFile, 0, NULL, FILE_BEGIN) == 0xFFFFFFF) {
		Close();
		return FALSE;
	}
	return TRUE;
}

//////////////////////////////////////////////////////////////////////
// ファイルクローズ
//////////////////////////////////////////////////////////////////////

void File::Close()
{
	if (hFile != INVALID_HANDLE_VALUE) {
		CloseHandle(hFile);
		hFile = INVALID_HANDLE_VALUE;
	}
}

//////////////////////////////////////////////////////////////////////
// ファイルポインタのシーク
//////////////////////////////////////////////////////////////////////

BOOL File::Seek(DWORD nPos)
{
	if (SetFilePointer(hFile, nPos, NULL, FILE_BEGIN) == 0xFFFFFFFF) return FALSE;
	return TRUE;
}

//////////////////////////////////////////////////////////////////////
// 現在のファイルポインタの取得
//////////////////////////////////////////////////////////////////////

DWORD File::CurrentPos()
{
	return SetFilePointer(hFile, 0, NULL, FILE_CURRENT);
}

//////////////////////////////////////////////////////////////////////
// ファイル読み込み
//////////////////////////////////////////////////////////////////////

BOOL File::Read(LPBYTE pBuf, LPDWORD pSize)
{
	DWORD n = *pSize;
	if (!ReadFile(hFile, pBuf, n, pSize, NULL)) return FALSE;
	return TRUE;
}

//////////////////////////////////////////////////////////////////////
// ファイル書き込み
//////////////////////////////////////////////////////////////////////

BOOL File::Write(const LPBYTE pBuf, DWORD nSize)
{
	DWORD n;
	if (!WriteFile(hFile, pBuf, nSize, &n, NULL)) return FALSE;
	return TRUE;
}
